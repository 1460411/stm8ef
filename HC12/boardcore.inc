; STM8S003F3P6 "HC12" STM8S device dependent routine default code

; Note: for supporting a new board create a new board configuration
;       folder with a "globconfig.inc" and a copy of this file.

; HC-12 I/O mapping of STM8S003P6:
;
; Pin# | Function          | board pin/signal
; 1    | PD4               | Si4463 p1 - SDN
; 2    | PD5/UART1_TX      | header TXD pad via level shifter
; 3    | PD6/UART1_RX      | header RXD pad via level shifter
; 4    | nRST              | reset test point nearest header RXD pad
; 11   | PB5               | header SET pad via level shifter
; 12   | PB4               | Si4463 p9  - GPIO0
; 13   | PC3               | Si4463 p10 - GPIO1
; 14   | PC4               | Si4463 p11 - nIRQ
; 15   | PC5/SPI_SCK       | Si4463 p12 - SCLK
; 16   | PC6/SPI_MOSI      | Si4463 p14 - SDI
; 17   | PC7/SPI_MISO      | Si4463 p13 - SDO
; 18   | PD1/SWIM          | SWIM test point nearest header TXD pad
; 19   | PD2               | Si4463 p15 - nSEL


;       BOARDINIT  ( -- )
;       Init board GPIO (except COM ports)

BOARDINIT:
        ; Board I/O initialization

        MOV     PD_ODR  ,#0x004       ; nSEL on PD2, SDN disabled by default
        MOV     PD_DDR  ,#0x014
        MOV     PD_CR1  ,#0x074       ; P-P for nSEL,SDN,UART1_TX, p/u for UART1_RX
        MOV     PC_CR1  ,#0x0F8       ; P-P for MOSI,SCLK, p/u for MISO,GPIO1
        MOV     PC_DDR  ,#0x060       ; OE for SCK and MOSI
        MOV     PB_CR1  ,#0x030       ; p/u for SET,GPIO0

        ; Set up SPI
        MOV     SPI_CR1 ,#0x014       ; master, CLK/8, CPOL=CPHA=0, MSB first
        MOV     SPI_CR2 ,#0x001       ; no NSS, FD, no CRC
        MOV     SPI_CR1 ,#0x054       ; enable SPI
        RET

;===============================================================

;      Dummy labels for PSIM interrupts declared in main.c

        .ifne   PSIM-PORTA
;       Dummy label for _EXTIA_IRQHandler
_EXTI0_IRQHandler:
        .endif

        .ifne   PSIM-PORTB
;       Dummy label for _EXTIB_IRQHandler
_EXTI1_IRQHandler:
        .endif

        .ifne   PSIM-PORTC
;       Dummy label for _EXTIC_IRQHandler
_EXTI2_IRQHandler:
        .endif

        .ifne   PSIM-PORTD
;       Dummy label for _EXTID_IRQHandler
_EXTI3_IRQHandler:
        .endif


; ==============================================

        .ifne   HAS_LED7SEG
;       LED_MPX driver ( -- )
;       Code called from ISR for LED MPX

LED_MPX:
        RET
        .endif

; ==============================================

        .ifne   HAS_OUTPUTS
;       OUT!  ( c -- )
;       Put c to board outputs, storing a copy in OUTPUTS
        .dw     LINK

        LINK =  .
        .db     (4)
        .ascii  "OUT!"
OUTSTOR:
        CALL    DROP
        RET
        .endif

; ==============================================
;       SPI  ( c -- c)
;       Perform SPI byte cycle with result c
        .dw     LINK

        LINK =  .
        .db     (3)
        .ascii  "SPI"
SPI:
        LD      A,(1,X)
        LD      SPI_DR,A
SPITXE_WAIT:
        BTJF    SPI_SR,#1,SPITXE_WAIT ;TXE
SPIRXNE_WAIT:
        BTJF    SPI_SR,#0,SPIRXNE_WAIT ;RXNE
        LD      A,SPI_DR
        LD      (1,X),A
        RET

;       SPIS    ( --  )
;       SPI frame start
; ===========================================================
        .dw     LINK
        LINK =  .
        .db     (4)
        .ascii  "SPIS"
SPIS:
        BRES    PD_ODR,#2  ; clear nRES
        RET

;       SPIE   ( --  )
;       SPI frame end
; ===========================================================
        .dw     LINK
        LINK =  .
        .db     (4)
        .ascii  "SPIE"
SPIE:
        BSET    PD_ODR,#2  ; set nRES
        RET

;       EZE   ( -- )
;       Enable EZRadio
; ===========================================================
        .dw     LINK
        LINK =  .
        .db     (3)
        .ascii  "EZE"
EZE:
        BRES    PD_ODR,#4  ; set SDN
        RET

;       EZD   ( --  )
;       Disable EZRadio
; ===========================================================
        .dw     LINK
        LINK =  .
        .db     (3)
        .ascii  "EZD"
EZD:
        BRES    PD_ODR,#4  ; clear SDN
        RET

        ; .include        "si4463init.inc"


;       EZSLIST ( -- a )
;       return address of list of init sequence start addresses

        .dw     LINK
        LINK =  .
        .db     7
        .ascii  "EZSLIST"
EZISEQ:
        CALL    DOVAR
        .dw     EZSEQ0
        .dw     EZSEQ1
        .dw     EZSEQ2
        .dw     EZSEQ30
        .dw     EZSEQ31
        .dw     EZSEQ50
        .dw     EZSEQ51
        .dw     EZSEQ52

EZSEQ0:
;    cmd 0
        .db     7,0x02,0x01,0x00,0x01,0xC9,0xC3,0x8
        .db     0 ; cmd 0 to cmd 0: 8 bytes

EZSEQ1:
;    cmd 1
        .db     7,0x13,0x60,0x48,0x57,0x56,0x5A,0x4B
        .db     0 ; cmd 1 to cmd 1: 8 bytes

EZSEQ2:
;    cmd 2
        .db     5,0x11,0x00,0x01,0x00,0x48
        .db     5,0x11,0x00,0x01,0x03,0x40
        .db     5,0x11,0x01,0x01,0x00,0x00
        .db     8,0x11,0x02,0x04,0x00,0x03,0x07,0x00,0x00
        .db     13,0x11,0x10,0x09,0x00,0x06,0x14,0x00,0x50,0x31,0x00,0x00,0x00,0x00
        .db     9,0x11,0x11,0x05,0x00,0x21,0x89,0x89,0x00,0x00
        .db     5,0x11,0x12,0x01,0x00,0x81
        .db     5,0x11,0x12,0x01,0x06,0x02
        .db     7,0x11,0x12,0x03,0x08,0x00,0x00,0x00
        .db     16,0x11,0x12,0x0C,0x0D,0x00,0x40,0x06,0xAA,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
        .db     12,0x11,0x12,0x08,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
        .db     16,0x11,0x20,0x0C,0x00,0x03,0x00,0x07,0x26,0x25,0xA0,0x01,0xC9,0xC3,0x80,0x00,0x22
        .db     5,0x11,0x20,0x01,0x0C,0x22
        .db     12,0x11,0x20,0x08,0x18,0x01,0x00,0x08,0x03,0x80,0x00,0x00,0x30
        .db     13,0x11,0x20,0x09,0x22,0x00,0x78,0x04,0x44,0x44,0x04,0x44,0x02,0x00
        .db     11,0x11,0x20,0x07,0x2C,0x00,0x23,0x8F,0xFF,0x00,0xDE,0xA0
        .db     5,0x11,0x20,0x01,0x35,0xE2
        .db     13,0x11,0x20,0x09,0x38,0x22,0x0D,0x0D,0x00,0x1A,0x40,0x00,0x00,0x28
        .db     15,0x11,0x20,0x0B,0x42,0xA4,0x03,0xD6,0x03,0x01,0x0A,0x01,0x80,0xFF,0x0C,0x00
        .db     5,0x11,0x20,0x01,0x4E,0x40
        .db     5,0x11,0x20,0x01,0x51,0x0A
        .db     16,0x11,0x21,0x0C,0x00,0x5B,0x47,0x0F,0xC0,0x6D,0x25,0xF4,0xDB,0xD6,0xDF,0xEC,0xF7
        .db     16,0x11,0x21,0x0C,0x0C,0xFE,0x01,0x15,0xF0,0xFF,0x03,0x5B,0x47,0x0F,0xC0,0x6D,0x25
        .db     16,0x11,0x21,0x0C,0x18,0xF4,0xDB,0xD6,0xDF,0xEC,0xF7,0xFE,0x01,0x15,0xF0,0xFF,0x03
        .db     8,0x11,0x22,0x04,0x00,0x08,0x7F,0x00,0x5D
        .db     11,0x11,0x23,0x07,0x00,0x01,0x05,0x0B,0x05,0x02,0x00,0x03
        .db     16,0x11,0x30,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
        .db     12,0x11,0x40,0x08,0x00,0x38,0x0D,0xDD,0xDD,0x36,0x9D,0x20,0xFE
        .db     0 ; cmd 2 to cmd 29: 313 bytes


EZSEQ30:
;    cmd 30
        .db     4,0x20,0x00,0x00,0x00
        .db     0 ; cmd 30 to cmd 30: 5 bytes

EZSEQ31:
;    cmd 31
        .db     16,0x11,0x20,0x0C,0x00,0x03,0x00,0x07,0x00,0xEA,0x60,0x04,0x2D,0xC6,0xC0,0x00,0x04
        .db     5,0x11,0x20,0x01,0x0C,0x19
        .db     12,0x11,0x20,0x08,0x18,0x01,0x80,0x08,0x03,0x80,0x00,0x20,0x10
        .db     13,0x11,0x20,0x09,0x22,0x00,0xA7,0x03,0x12,0x6F,0x01,0x88,0x02,0xC2
        .db     11,0x11,0x20,0x07,0x2C,0x04,0x36,0x80,0x2C,0x07,0xE9,0x80
        .db     13,0x11,0x20,0x09,0x38,0x11,0x25,0x25,0x00,0x1A,0x80,0x00,0x00,0x29
        .db     15,0x11,0x20,0x0B,0x42,0xA4,0x02,0xD6,0x83,0x01,0x44,0x01,0x80,0xFF,0x0C,0x00
        .db     16,0x11,0x21,0x0C,0x00,0xCC,0xA1,0x30,0xA0,0x21,0xD1,0xB9,0xC9,0xEA,0x05,0x12,0x11
        .db     16,0x11,0x21,0x0C,0x0C,0x0A,0x04,0x15,0xFC,0x03,0x00,0xCC,0xA1,0x30,0xA0,0x21,0xD1
        .db     16,0x11,0x21,0x0C,0x18,0xB9,0xC9,0xEA,0x05,0x12,0x11,0x0A,0x04,0x15,0xFC,0x03,0x00
        .db     8,0x11,0x22,0x04,0x00,0x08,0x7F,0x00,0x3D
        .db     11,0x11,0x23,0x07,0x00,0x2C,0x0E,0x0B,0x04,0x0C,0x73,0x03
        .db     5,0x11,0x22,0x01,0x01,0x7F
        .db     0 ; cmd 31 to cmd 43: 170 bytes

;    cmd 44
        .db     2,0x15,0x00

;    cmd 48
        .db     1,0x33
        .db     5,0x44,0xFF,0xFF,0xFF,0xFF
        .db     5,0x44,0xFF,0xFF,0xFF,0xFF
        .db     0 ; cmd 48 to cmd 50: 14 bytes
;    cmd 51
        .db     8,0x32,0x02,0x00,0x00,0x14,0x00,0x01,0x03
        .db     0 ; cmd 51 to cmd 51: 9 bytes
;        541
